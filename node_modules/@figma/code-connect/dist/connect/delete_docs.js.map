{"version":3,"file":"delete_docs.js","sourceRoot":"","sources":["../../src/connect/delete_docs.ts"],"names":[],"mappings":"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","sourcesContent":["import { isFetchError, request } from '../common/fetch'\nimport { logger } from '../common/logging'\nimport { getApiUrl, getHeaders } from './figma_rest_api'\nimport { exitWithFeedbackMessage } from './helpers'\n\ninterface NodesToDeleteInfo {\n  figmaNode: string\n  label: string\n}\n\ninterface Args {\n  accessToken: string\n  docs: NodesToDeleteInfo[]\n  apiUrl?: string\n}\n\nexport async function delete_docs({ accessToken, docs, apiUrl: apiUrlOverride }: Args) {\n  const apiUrl = getApiUrl(docs?.[0]?.figmaNode ?? '', apiUrlOverride) + '/code_connect'\n\n  try {\n    logger.info(`Unpublishing Code Connect files from Figma...`)\n\n    const response = await request.delete(\n      apiUrl,\n      { nodes_to_delete: docs },\n      {\n        headers: getHeaders(accessToken),\n      },\n    )\n\n    interface DeleteResult {\n      success: boolean\n      deleted_count: number\n      failed_count: number\n      deleted_nodes: Array<{ figmaNode: string; label: string }>\n      failed_nodes: Array<{ figmaNode: string; label: string; reason: string }>\n    }\n\n    const responseData = response.data as {\n      meta?: DeleteResult\n    }\n\n    const result: DeleteResult = responseData.meta ?? (response.data as DeleteResult)\n\n    if (result.deleted_count > 0) {\n      logger.info(\n        `\\nSuccessfully deleted ${\n          result.deleted_count\n        } Code Connect mapping(s):\\n${result.deleted_nodes\n          .map((doc) => `${doc.figmaNode} (${doc.label})`)\n          .join('\\n')}`,\n      )\n    }\n\n    if (result.failed_count > 0) {\n      logger.error(\n        `\\nFailed to delete ${result.failed_count} Code Connect mapping(s):\\n${result.failed_nodes\n          .map((doc) => `âœ— ${doc.figmaNode} (${doc.label}): ${doc.reason}`)\n          .join('\\n')}`,\n      )\n      exitWithFeedbackMessage(1)\n    }\n\n    if (result.deleted_count === 0 && result.failed_count === 0) {\n      logger.warn('No Code Connect mappings were found to delete.')\n    }\n  } catch (err) {\n    if (isFetchError(err)) {\n      if (err.response) {\n        // Provide more specific error message based on status code\n        if (err.response.status === 400) {\n          const errorMsg = err.data?.err ?? err.data?.message ?? 'Bad request'\n          if (errorMsg.includes('insufficient permissions')) {\n            logger.error(`Insufficient permissions to unpublish Code Connect for this file.`)\n          } else if (errorMsg.includes('Failed to parse')) {\n            logger.error(`Invalid Figma URL format in the request.`)\n          } else {\n            logger.error(`Failed to unpublish from Figma: ${errorMsg}`)\n          }\n        } else {\n          logger.error(\n            `Failed to unpublish from Figma (${err.response.status}): ${\n              err.data?.err ?? err.data?.message ?? 'Unknown error'\n            }`,\n          )\n        }\n      } else {\n        logger.error(`Failed to unpublish from Figma: ${err.message}`)\n      }\n      logger.debug(JSON.stringify(err.data))\n    } else {\n      logger.error(`Failed to delete docs: ${err}`)\n    }\n    exitWithFeedbackMessage(1)\n  }\n}\n"]}