{"version":3,"file":"migration_helpers.js","sourceRoot":"","sources":["../../src/connect/migration_helpers.ts"],"names":[],"mappings":"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","sourcesContent":["import fs from 'fs'\nimport path from 'path'\nimport * as prettier from 'prettier'\nimport { CodeConnectJSON } from '../connect/figma_connect'\n\nexport function writeTemplateFile(\n  doc: CodeConnectJSON,\n  outputDir: string | undefined,\n  baseDir: string,\n  localSourcePath?: string,\n  filePathsCreated?: Set<string>,\n  removeProps?: boolean,\n): { outputPath: string; skipped: boolean } {\n  const suffix = '.figma.js'\n\n  // Determine base output filename\n  let baseOutputPath: string\n\n  if (outputDir) {\n    // Use specified output directory\n    const filename = `${doc.component || 'template'}${suffix}`\n    baseOutputPath = path.join(outputDir, filename)\n  } else if (localSourcePath) {\n    // Use same directory as local source file\n    const sourceDir = path.dirname(localSourcePath)\n    let sourceBasename = path.basename(localSourcePath)\n\n    // If this is a Code Connect file, extract the base component name\n    // Handles patterns like: Button.figma.tsx, Button.figmadoc.tsx, Button.figma.template.js\n    // Should all become: Button.figma.js\n    const codeConnectPattern = /\\.(figma|figmadoc)(\\.[^.]+)+$/\n    if (codeConnectPattern.test(sourceBasename)) {\n      // Extract everything before the .figma/.figmadoc pattern\n      sourceBasename = sourceBasename.replace(codeConnectPattern, '')\n    } else {\n      // For regular component files, strip extension normally\n      sourceBasename = path.basename(localSourcePath, path.extname(localSourcePath))\n    }\n\n    const filename = `${sourceBasename}${suffix}`\n    baseOutputPath = path.join(sourceDir, filename)\n  } else {\n    // No source info, use current directory\n    const filename = `${doc.component || 'template'}${suffix}`\n    baseOutputPath = path.join(baseDir, filename)\n  }\n\n  // Check if file already exists on disk (pre-existing file, not created in this run)\n  const existsOnDisk = fs.existsSync(baseOutputPath)\n  const createdInThisRun = filePathsCreated && filePathsCreated.has(baseOutputPath)\n\n  if (existsOnDisk && !createdInThisRun) {\n    // This file existed before the migration run, skip it\n    return { outputPath: baseOutputPath, skipped: true }\n  }\n\n  // Handle duplicate names (either created in this run or would conflict with an existing file)\n  let outputPath = baseOutputPath\n  if (createdInThisRun || existsOnDisk) {\n    // Find a unique name by appending _1, _2, etc. before the suffix\n    const dir = path.dirname(baseOutputPath)\n    const basename = path.basename(baseOutputPath)\n\n    // Remove the suffix to get the base name (works for any suffix like .figma.js or .figma.ts)\n    const baseNameWithoutSuffix = basename.endsWith(suffix)\n      ? basename.slice(0, -suffix.length)\n      : basename\n\n    let counter = 1\n    do {\n      outputPath = path.join(dir, `${baseNameWithoutSuffix}_${counter}${suffix}`)\n      counter++\n    } while ((filePathsCreated && filePathsCreated.has(outputPath)) || fs.existsSync(outputPath))\n  }\n\n  let template = doc.template\n\n  template = removeSwiftHelpers(template)\n  // Helpers have not been injected - replace reference with server-side versions\n  template = migrateTemplateToUseServerSideHelpers(template)\n  // Remove __props definition and from metadata (if flag is set)\n  if (removeProps) {\n    template = removePropsDefinitionAndMetadata(template)\n  }\n  // V1 -> V2 codemods\n  template = migrateV1TemplateToV2(template)\n  // Add required id to template (set to TODO if no usable name)\n  template = addId(template, doc.component || 'TODO')\n  // Add imports if present\n  template = addImports(template, doc.templateData?.imports)\n  // Add nestable to metadata (default to false)\n  template = addNestableToMetadata(template, !!doc.templateData?.nestable)\n  // Format for ease of use\n  template = prettier.format(template, {\n    parser: 'typescript',\n    semi: false,\n    trailingComma: 'all',\n    // pluginSearchDirs: false is needed as otherwise prettier picks up other\n    // prettier plugins in our monorepo and fails with race condition errors\n    pluginSearchDirs: false,\n  })\n\n  // Create the template file content\n\n  // Build comment header lines\n  const commentLines: string[] = [`// url=${doc.figmaNode}`] // URL is required\n  if (doc.source) {\n    commentLines.push(`// source=${doc.source}`)\n  }\n  if (doc.component) {\n    commentLines.push(`// component=${doc.component}`)\n  }\n  commentLines.push(``)\n\n  const fileContent = commentLines.join('\\n') + '\\n' + template\n\n  // Ensure output directory exists\n  const outputDirPath = path.dirname(outputPath)\n  if (!fs.existsSync(outputDirPath)) {\n    fs.mkdirSync(outputDirPath, { recursive: true })\n  }\n\n  // Write the file\n  fs.writeFileSync(outputPath, fileContent, 'utf-8')\n\n  // Track the created file path\n  if (filePathsCreated) {\n    filePathsCreated.add(outputPath)\n  }\n\n  return { outputPath, skipped: false }\n}\n\n// Renames must match helpers in code_connect_js_api.raw_source.ts\nexport function migrateTemplateToUseServerSideHelpers(template: string) {\n  return (\n    template\n      // React helpers\n      .replace(/_fcc_renderReactProp/g, 'figma.helpers.react.renderProp')\n      .replace(/_fcc_renderReactChildren/g, 'figma.helpers.react.renderChildren')\n      .replace(/_fcc_jsxElement/g, 'figma.helpers.react.jsxElement')\n      .replace(/_fcc_function/g, 'figma.helpers.react.function')\n      .replace(/_fcc_identifier/g, 'figma.helpers.react.identifier')\n      .replace(/_fcc_object/g, 'figma.helpers.react.object')\n      .replace(/_fcc_templateString/g, 'figma.helpers.react.templateString')\n      .replace(/_fcc_renderPropValue/g, 'figma.helpers.react.renderPropValue')\n      .replace(/_fcc_stringifyObject/g, 'figma.helpers.react.stringifyObject')\n      .replace(/_fcc_reactComponent/g, 'figma.helpers.react.reactComponent')\n      .replace(/_fcc_array/g, 'figma.helpers.react.array')\n      .replace(/isReactComponentArray/g, 'figma.helpers.react.isReactComponentArray')\n      // Swift helpers\n      .replace(/__fcc_renderSwiftChildren/g, 'figma.helpers.swift.renderChildren')\n      // Kotlin/Compose helpers\n      .replace(/__fcc_renderComposeChildren/g, 'figma.helpers.kotlin.renderChildren')\n  )\n}\n\nexport function addId(template: string, id: string): string {\n  return template.replace(/export default \\{/, `export default { id: '${id}',`)\n}\n\nexport function addImports(template: string, imports: string[] | undefined): string {\n  if (!imports || imports.length === 0) {\n    return template\n  }\n\n  // Escape imports for safe insertion into JS\n  const importsJson = JSON.stringify(imports)\n\n  // Add imports after the id field if it exists, otherwise at the start\n  // Match: export default { id: '...', (with optional whitespace/newlines)\n  const withId = template.replace(\n    /(export default\\s*\\{\\s*id:\\s*'[^']*',)/,\n    `$1 imports: ${importsJson},`,\n  )\n\n  // If id replacement worked, return\n  if (withId !== template) {\n    return withId\n  }\n\n  // Otherwise, add at the start (after opening brace)\n  return template.replace(/export default\\s*\\{/, `export default { imports: ${importsJson},`)\n}\n\nexport function addNestableToMetadata(template: string, nestable: boolean): string {\n  // Find \"metadata: {\" and replace with \"metadata: { nestable: <value>,\"\n  return template.replace(/metadata:\\s*\\{/, `metadata: { nestable: ${nestable},`)\n}\n\n/**\n * Migrates V1 templates to V2 API.\n *\n * This performs safe, incremental transformations. The following patterns\n * are intentionally NOT migrated as they're still supported in V2:\n *\n * - __props metadata building pattern - still valid JavaScript\n * - __renderWithFn__() - complex transformation, still supported\n *\n * These may be addressed in future migrations.\n */\nexport const migrateV1TemplateToV2 = (template: string): string => {\n  let migrated = template\n\n  // 1. Core object rename\n  migrated = migrated.replace(/figma\\.currentLayer/g, 'figma.selectedInstance')\n\n  // 2. Normalize template types to figma.code\n  migrated = migrated.replace(/figma\\.html/g, 'figma.code')\n  migrated = migrated.replace(/figma\\.tsx/g, 'figma.code')\n  migrated = migrated.replace(/figma\\.swift/g, 'figma.code')\n  migrated = migrated.replace(/figma\\.kotlin/g, 'figma.code')\n\n  // 3. Property accessor methods\n  migrated = migrated.replace(/\\.__properties__\\.string\\(/g, '.getString(')\n  migrated = migrated.replace(/\\.__properties__\\.boolean\\(/g, '.getBoolean(')\n  migrated = migrated.replace(/\\.__properties__\\.enum\\(/g, '.getEnum(')\n  migrated = migrated.replace(/\\.__properties__\\.__instance__\\(/g, '.getInstanceSwap(')\n  // .__properties__.instance() auto-renders, so we need to add .executeTemplate().example\n  migrated = migrated.replace(\n    /\\.__properties__\\.instance\\(([^)]+)\\)/g,\n    '.getInstanceSwap($1)?.executeTemplate().example',\n  )\n\n  // 4. Alias for __properties__ on selectedInstance\n  migrated = migrated.replace(/figma\\.selectedInstance\\.__properties__\\./g, 'figma.properties.')\n\n  // 5. Other method renames\n  migrated = migrated.replace(/\\.__getPropertyValue__\\(/g, '.getPropertyValue(')\n\n  // 6. __findChildWithCriteria__ - migrate based on type parameter\n  // For TEXT type with __render__(): __findChildWithCriteria__({ name: 'X', type: \"TEXT\" }).__render__() → findText('X').textContent\n  migrated = migrated.replace(\n    /\\.__findChildWithCriteria__\\(\\{\\s*name:\\s*'([^']+)',\\s*type:\\s*\"TEXT\"\\s*\\}\\)\\.__render__\\(\\)/g,\n    \".findText('$1').textContent\",\n  )\n  migrated = migrated.replace(\n    /\\.__findChildWithCriteria__\\(\\{\\s*type:\\s*\"TEXT\",\\s*name:\\s*'([^']+)'\\s*\\}\\)\\.__render__\\(\\)/g,\n    \".findText('$1').textContent\",\n  )\n  // For INSTANCE type: __findChildWithCriteria__({ type: 'INSTANCE', name: 'X' }) → findInstance('X')\n  migrated = migrated.replace(\n    /\\.__findChildWithCriteria__\\(\\{\\s*name:\\s*'([^']+)',\\s*type:\\s*['\"]INSTANCE['\"]\\s*\\}\\)/g,\n    \".findInstance('$1')\",\n  )\n  migrated = migrated.replace(\n    /\\.__findChildWithCriteria__\\(\\{\\s*type:\\s*['\"]INSTANCE['\"],\\s*name:\\s*'([^']+)'\\s*\\}\\)/g,\n    \".findInstance('$1')\",\n  )\n  // For TEXT type without __render__(): __findChildWithCriteria__({ type: 'TEXT', name: 'X' }) → findText('X')\n  migrated = migrated.replace(\n    /\\.__findChildWithCriteria__\\(\\{\\s*name:\\s*'([^']+)',\\s*type:\\s*['\"]TEXT['\"]\\s*\\}\\)/g,\n    \".findText('$1')\",\n  )\n  migrated = migrated.replace(\n    /\\.__findChildWithCriteria__\\(\\{\\s*type:\\s*['\"]TEXT['\"],\\s*name:\\s*'([^']+)'\\s*\\}\\)/g,\n    \".findText('$1')\",\n  )\n\n  // 7. __find__() - migrate to findInstance()\n  migrated = migrated.replace(\n    /\\.__find__\\((\"([^\"]+)\"|'([^']+)')\\)/g,\n    (match, quote, doubleQuoted, singleQuoted) => {\n      const name = doubleQuoted || singleQuoted\n      return `.findInstance(\"${name}\")`\n    },\n  )\n\n  // 8. __render__() - migrate to executeTemplate().example (but not if part of __findChildWithCriteria__)\n  migrated = migrated.replace(/\\.__render__\\(\\)/g, '.executeTemplate().example')\n\n  // 9. __getProps__() - migrate to executeTemplate().metadata.props\n  migrated = migrated.replace(/\\.__getProps__\\(\\)/g, '.executeTemplate().metadata.props')\n\n  // 10. Export format - simple case\n  // Match export default figma.code` (or tsx, html, etc) and wrap in { example: ... }\n  migrated = migrated.replace(\n    /export default figma\\.(code|tsx|html|swift|kotlin)`/g,\n    'export default { example: figma.$1`',\n  )\n  // Close the template literal for simple exports (look for backtick at end, handling multiline)\n  // Use a more robust approach: find the last backtick that's not followed by more content\n  migrated = migrated.replace(\n    /(export default \\{ example: figma\\.\\w+`[\\s\\S]*?)`(?=\\s*$)/gm,\n    '$1` }',\n  )\n\n  // 11. Export format - spread operator case\n  // { ...figma.code`...`, metadata: ... } → { example: figma.code`...`, metadata: ... }\n  migrated = migrated.replace(\n    /\\{\\s*\\.\\.\\.figma\\.(code|tsx|html|swift|kotlin)`/g,\n    '{ example: figma.$1`',\n  )\n\n  return migrated\n}\n\n/**\n * Removes the __props definition and props assignments. These are only used by icons\n * helpers and significantly bloat templates.\n */\nexport function removePropsDefinition(template: string): string {\n  // Match from \"const __props = {\" through everything up until (but not including) \"export default {\"\n  // Uses [\\s\\S] to match any character including newlines\n  return template.replace(/const\\s+__props\\s*=\\s*\\{[\\s\\S]*?(?=export\\s+default\\s*\\{)/g, '\\n')\n}\n\n/**\n * Removes the __props definition/assignments and removes __props from the default export\n */\nexport function removePropsDefinitionAndMetadata(template: string): string {\n  // First remove the __props definition and assignments\n  let result = removePropsDefinition(template)\n  const exportMatch = result.match(/(export\\s+default\\s+\\{[\\s\\S]*$)/)\n  if (exportMatch) {\n    const exportSection = exportMatch[1]\n    const cleanedExport = exportSection\n      .replace(/metadata:\\s*\\{\\s*__props\\s*\\}/g, 'metadata: {}') // metadata: { __props }\n      .replace(/metadata:\\s*\\{\\s*__props\\s*,/g, 'metadata: {') // metadata: { __props, ...\n      .replace(/,\\s*__props\\s*\\}/g, ' }') // metadata: { ..., __props }\n      .replace(/,\\s*__props\\s*,/g, ',') // metadata: { ..., __props, ... }\n\n    result = result.substring(0, result.indexOf(exportSection)) + cleanedExport\n  }\n\n  return result\n}\n\ntype CodeConnectObjectsForFigmaUrl = {\n  main: CodeConnectJSON | null\n  variants: CodeConnectJSON[]\n}\n\n/**\n * For each figmaUrl in the given codeConnectObjects, return the main (non-variant)\n * codeConnectObject plus a list of any variants\n */\nexport const groupCodeConnectObjectsByFigmaUrl = (codeConnectObjects: CodeConnectJSON[]) => {\n  return codeConnectObjects.reduce(\n    (acc, obj) => {\n      const figmaUrl = obj.figmaNode\n      if (!acc[figmaUrl]) {\n        acc[figmaUrl] = { main: null, variants: [] }\n      }\n\n      if (obj.variant && Object.keys(obj.variant).length > 0) {\n        acc[figmaUrl].variants.push(obj)\n      } else {\n        acc[figmaUrl].main = obj\n      }\n\n      return acc\n    },\n    {} as Record<string, CodeConnectObjectsForFigmaUrl>,\n  )\n}\n\nfunction removeSwiftHelpers(template: string): string {\n  return template.replace(\n    `function __fcc_renderSwiftChildren(children, prefix) {\n  if (children === undefined) {\n    return children\n  }\n  return children.flatMap((child, index) => {\n    if (child.type === 'CODE') {\n      let code = child.code.split('\\\\n').map((line) => {\n        return line.trim() !== '' ? \\`\\${prefix}\\${line}\\` : line;\n      }).join('\\\\n')\n      if (index !== children.length - 1) {\n        code = code + '\\\\n'\n      }\n      return {\n        ...child,\n        code: code,\n      }\n    } else {\n        let elements = []\n        const shouldAddNewline = index > 0 && children[index - 1].type === 'CODE' && !children[index - 1].code.endsWith('\\\\n')\n        elements.push({ type: 'CODE', code: \\`\\${shouldAddNewline ? '\\\\n' : ''}\\${prefix}\\` })\n        elements.push(child)\n        if (index !== children.length - 1) {\n            elements.push({ type: 'CODE', code: '\\\\n' })\n        }\n        return elements\n    }\n  })\n}\n`,\n    '',\n  )\n}\n"]}