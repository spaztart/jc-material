{"version":3,"file":"helpers.js","sourceRoot":"","sources":["../../../src/connect/wizard/helpers.ts"],"names":[],"mappings":"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","sourcesContent":["import * as prettier from 'prettier'\nimport fs from 'fs'\nimport {\n  CodeConnectConfig,\n  CodeConnectParser,\n  DEFAULT_INCLUDE_GLOBS_BY_PARSER,\n  DEFAULT_LABEL_PER_PARSER,\n  ProjectInfo,\n  ReactProjectInfo,\n  getDefaultConfigPath,\n  getEnvPath,\n} from '../project'\nimport { exitWithError, logger, success } from '../../common/logging'\nimport path from 'path'\nimport prompts, { Choice } from 'prompts'\nimport { BaseCommand } from '../../commands/connect'\nimport { isFigmaConnectFile } from '../parser_common'\nimport { parseFileKey } from '../helpers'\n\nexport function maybePrefillWizardQuestionsForTesting() {\n  if (process.env.JEST_WORKER_ID && process.env.WIZARD_ANSWERS_TO_PREFILL) {\n    const unescapedJson = JSON.parse(process.env.WIZARD_ANSWERS_TO_PREFILL.replace(/\\\\\"/g, '\"'))\n    prompts.inject(unescapedJson)\n  }\n}\n\n/**\n *\n * Gets the default include globs for config.parser with componentDirectory prepended\n * @param args\n * @param args.dir project root path\n * @param args.componentDirectory optional path to where includes should be limited to\n * @param args.config CodeConnectConfig\n * @returns array of include globs\n */\nexport function getIncludesGlob({\n  dir,\n  componentDirectory,\n  config,\n}: {\n  dir: string\n  componentDirectory: string | null\n  config: CodeConnectConfig\n}) {\n  if (componentDirectory) {\n    // use unix separators for config file globs\n    const pathToComponentsDir = path.relative(dir, componentDirectory).replaceAll(path.sep, '/')\n    if (config.parser === 'custom') {\n      return []\n    }\n    return DEFAULT_INCLUDE_GLOBS_BY_PARSER[config.parser].map(\n      (defaultIncludeGlob) => `${pathToComponentsDir}/${defaultIncludeGlob}`,\n    )\n  }\n  return DEFAULT_INCLUDE_GLOBS_BY_PARSER[config.parser]\n}\n\nexport async function createEnvFile({ dir, accessToken }: { dir: string; accessToken?: string }) {\n  // Create .env file\n  const filePath = getDefaultConfigPath(dir)\n  fs.writeFileSync(getEnvPath(dir), `FIGMA_ACCESS_TOKEN=\"${accessToken}\"`)\n  logger.info(success(`Created ${filePath}`))\n}\n\nexport function addTokenToEnvFile({ dir, accessToken }: { dir: string; accessToken?: string }) {\n  const filePath = getDefaultConfigPath(dir)\n  fs.appendFileSync(getEnvPath(dir), `\\nFIGMA_ACCESS_TOKEN=\"${accessToken}\"`)\n  logger.info(success(`Appended access token to ${filePath}`))\n}\n\nexport async function createCodeConnectConfig({\n  dir,\n  componentDirectory,\n  config,\n  figmaUrl,\n}: {\n  dir: string\n  componentDirectory: string | null\n  config: CodeConnectConfig\n  figmaUrl: string\n}) {\n  const label = DEFAULT_LABEL_PER_PARSER[config.parser as CodeConnectParser]\n  const includesGlob = getIncludesGlob({ dir, componentDirectory, config })\n\n  const configJson = label\n    ? `{\n  \"codeConnect\": {\n    \"include\": [\"${includesGlob}\"],\n    \"label\": \"${label}\",\n    \"interactiveSetupFigmaFileUrl\": \"${figmaUrl}\",\n}\n}`\n    : `{\n  \"codeConnect\": {\n    \"include\": [\"${includesGlob}\"],\n    \"interactiveSetupFigmaFileUrl\": \"${figmaUrl}\",\n  }\n}`\n\n  const formatted = await prettier.format(configJson, {\n    parser: 'json',\n  })\n  const filePath = getDefaultConfigPath(dir)\n\n  fs.writeFileSync(filePath, formatted)\n\n  logger.info(success(`Created ${filePath}`))\n}\n\nconst FILEPATH_EXPORT_DELIMITER = '~'\n\nexport function parseFilepathExport(filepathExport: string) {\n  const delimiterLastIndex = filepathExport.lastIndexOf(FILEPATH_EXPORT_DELIMITER)\n\n  if (delimiterLastIndex === -1) {\n    return {\n      filepath: filepathExport,\n      exportName: null,\n    }\n  }\n  return {\n    filepath: filepathExport.substring(0, delimiterLastIndex),\n    exportName: filepathExport.substring(delimiterLastIndex + 1),\n  }\n}\n\nexport function getFilepathExport(filepath: string, exp: string) {\n  return `${filepath}${FILEPATH_EXPORT_DELIMITER}${exp}`\n}\n\n/**\n * Formats an array of filepathExports into a map of filepaths->exports\n *\n * @param filepathExports an array of components in the format `${filepath}~${componentName}\n * @returns a map of filepaths to an array of their exports. Array is empty if no exports found\n */\nexport function getComponentOptionsMap(filepathExports: string[]) {\n  return filepathExports.reduce(\n    (acc, filepathExport) => {\n      const { filepath, exportName } = parseFilepathExport(filepathExport)\n      acc[filepath] = acc[filepath] || []\n      if (exportName) {\n        acc[filepath].push({\n          title: exportName,\n          value: getFilepathExport(filepath, exportName),\n        })\n      }\n      return acc\n    },\n    {} as Record<string, Choice[]>,\n  )\n}\n\n/**\n * Parses a ProjectInfo for any TS exports (or filepaths if not a TS project)\n *\n * @param projectInfo\n * @returns an array of components in the format `${filepath}~${componentName}\n */\nexport function getFilepathExportsFromFiles(projectInfo: ProjectInfo, cmd: BaseCommand) {\n  return projectInfo.files.reduce((options, filepath) => {\n    if (projectInfo.config.parser === 'react') {\n      const { tsProgram } = projectInfo as ReactProjectInfo\n      if (!isFigmaConnectFile(tsProgram, filepath, 'tsx')) {\n        const checker = tsProgram.getTypeChecker()\n        const sourceFile = tsProgram.getSourceFile(filepath)\n        if (!sourceFile) {\n          if (cmd.verbose) {\n            logger.warn(`Could not parse file for TypeScript: ${filepath}`)\n          }\n        } else {\n          try {\n            const sourceFileSymbol = checker.getSymbolAtLocation(sourceFile)!\n            const exports = checker.getExportsOfModule(sourceFileSymbol)\n\n            exports.forEach((exp) => {\n              options.push(getFilepathExport(filepath, exp.getName()))\n            })\n          } catch (e) {\n            if (cmd.verbose) {\n              logger.warn(`Could not parse exports of file: ${filepath}`)\n            }\n            // ignore invalid files\n          }\n        }\n      }\n    } else {\n      options.push(filepath)\n    }\n    return options\n  }, [] as string[])\n}\n\nexport function isValidFigmaUrl(url: string) {\n  try {\n    const { hostname } = new URL(url)\n    if (\n      !hostname.includes('figma.com')\n    ) {\n      return false\n    }\n\n    return !!parseFileKey(url)\n  } catch (e) {\n    return false\n  }\n}\n"]}