{"version":3,"file":"create.js","sourceRoot":"","sources":["../../src/connect/create.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  exitWithFeedbackMessage,\n  findComponentsInDocument,\n  parseFileKey,\n  parseNodeIds,\n} from './helpers'\nimport fs from 'fs'\nimport { FigmaRestApi, getApiUrl, getHeaders } from './figma_rest_api'\nimport { exitWithError, logger } from '../common/logging'\nimport { callParser, handleMessages } from './parser_executables'\nimport { CodeConnectExecutableParserConfig, ProjectInfo } from './project'\nimport { createReactCodeConnect } from '../react/create'\nimport { z } from 'zod'\nimport {\n  CreateRequestPayload,\n  CreateRequestPayloadMulti,\n  CreateResponsePayload,\n} from './parser_executable_types'\nimport { fromError } from 'zod-validation-error'\nimport { createHtmlCodeConnect } from '../html/create'\nimport { isFetchError, request } from '../common/fetch'\nimport { BaseCommand } from '../commands/connect'\n\ninterface GenerateDocsArgs {\n  accessToken: string\n  figmaNodeUrl: string\n  outFile: string\n  outDir: string\n  projectInfo: ProjectInfo\n  cmd: BaseCommand\n}\n\nexport function normalizeComponentName(name: string) {\n  // Convert the string to PascalCase and ensure first character is not a digit\n  return name\n    .replace(/[^a-zA-Z0-9]/g, ' ')\n    .split(' ')\n    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))\n    .join('')\n    .replace(/^[0-9]/, '_$&')\n}\n\nexport async function createCodeConnectFromUrl({\n  accessToken,\n  figmaNodeUrl,\n  outFile,\n  outDir,\n  projectInfo,\n  cmd,\n}: GenerateDocsArgs) {\n  try {\n    const fileKey = parseFileKey(figmaNodeUrl)\n    const nodeIds = parseNodeIds([figmaNodeUrl])\n\n    const apiUrl =\n      getApiUrl(figmaNodeUrl ?? '', cmd.apiUrl || projectInfo.config.apiUrl) +\n      `/code_connect/${fileKey}/cli_data?ids=${nodeIds.join(',')}`\n\n    if (nodeIds.length === 0) {\n      exitWithError(\n        `Invalid figma node URL: the provided url \"${figmaNodeUrl}\" does not contain a node-id`,\n      )\n    } else if (nodeIds.length > 1) {\n      exitWithError(\n        `Invalid figma node URL: the provided url \"${figmaNodeUrl}\" contains more than one node-id`,\n      )\n    }\n\n    logger.info('Fetching component information from Figma...')\n    const response = process.env.CODE_CONNECT_MOCK_CREATE_API_RESPONSE\n      ? {\n          response: { status: 200 },\n          data: JSON.parse(\n            fs.readFileSync(process.env.CODE_CONNECT_MOCK_CREATE_API_RESPONSE, 'utf-8'),\n          ) as { document: FigmaRestApi.Node },\n        }\n      : await request.get<{ document: FigmaRestApi.Node }>(apiUrl, {\n          headers: getHeaders(accessToken),\n        })\n\n    if (response.response.status === 200) {\n      logger.info('Parsing response')\n      const component = findComponentsInDocument(response.data.document, nodeIds)[0]\n      if (component === undefined) {\n        exitWithError('Could not find a component in the provided URL')\n      }\n      const normalizedName = normalizeComponentName(component.name)\n\n      const componentPayload = {\n        figmaNodeUrl,\n        id: component.id,\n        name: component.name,\n        normalizedName,\n        type: component.type,\n        componentPropertyDefinitions: component.componentPropertyDefinitions,\n      }\n\n      logger.info('Generating Code Connect files...')\n\n      let result: z.infer<typeof CreateResponsePayload>\n\n      if (projectInfo.config.parser === 'react') {\n        const payload: CreateRequestPayloadMulti = {\n          mode: 'CREATE',\n          destinationDir: outDir ?? process.env.INIT_CWD ?? process.cwd(),\n          destinationFile: outFile,\n          normalizedName,\n          figmaConnections: [{ component: componentPayload }],\n          config: projectInfo.config,\n        }\n        result = await createReactCodeConnect(payload)\n      } else if (projectInfo.config.parser === 'html') {\n        const payload: CreateRequestPayloadMulti = {\n          mode: 'CREATE',\n          destinationDir: outDir ?? process.env.INIT_CWD ?? process.cwd(),\n          destinationFile: outFile,\n          normalizedName,\n          figmaConnections: [{ component: componentPayload }],\n          config: projectInfo.config,\n        }\n        result = await createHtmlCodeConnect(payload)\n      } else {\n        try {\n          const payload: CreateRequestPayload = {\n            mode: 'CREATE',\n            destinationDir: outDir ?? process.env.INIT_CWD ?? process.cwd(),\n            destinationFile: outFile,\n            component: componentPayload,\n            config: projectInfo.config,\n            verbose: cmd.verbose,\n          }\n          const stdout = await callParser(\n            // We use `as` because the React parser makes the types difficult\n            // TODO remove once React is an executable parser\n            projectInfo.config as CodeConnectExecutableParserConfig,\n            payload,\n            projectInfo.absPath,\n          )\n\n          result = CreateResponsePayload.parse(stdout)\n        } catch (e) {\n          throw fromError(e)\n        }\n      }\n\n      const { hasErrors } = handleMessages(result.messages)\n\n      if (hasErrors) {\n        exitWithError('Errors encountered calling parser, exiting')\n      }\n\n      logger.info('Code Connect files generated successfully:')\n      result.createdFiles.forEach((file) => {\n        logger.info(`${file.filePath}`)\n      })\n    } else {\n      logger.error(\n        `Failed to get node information from Figma with status: ${response.response.status}`,\n      )\n      logger.debug('Failed to get node information from Figma with Body:', response.data)\n    }\n  } catch (err) {\n    if (isFetchError(err)) {\n      if (err.response) {\n        logger.error(\n          `Failed to get node data from Figma (${err.response.status}): ${err.response.status} ${err.data?.err ?? err.data?.message}`,\n        )\n      } else {\n        logger.error(`Failed to get node data from Figma: ${err.message}`)\n      }\n      logger.debug(JSON.stringify(err.data))\n    } else {\n      logger.error(`Failed to create: ${err}`)\n    }\n    exitWithFeedbackMessage(1)\n  }\n}\n"]}